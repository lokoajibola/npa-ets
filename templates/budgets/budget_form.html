{% extends 'base.html' %}
{% load crispy_forms_tags %}
{% load static %}

{% block page_title %}{{ page_title }}{% endblock %}

{% block extra_css %}
<style>
    .budget-table {
        font-size: 0.9rem;
    }
    .budget-table th {
        background-color: #003087;
        color: white;
        font-weight: 600;
        text-align: center;
        vertical-align: middle;
        padding: 8px 4px;
    }
    .budget-table td {
        padding: 6px 4px;
        vertical-align: middle;
    }
    .budget-input {
        border: none;
        border-bottom: 1px solid #dee2e6;
        width: 100%;
        padding: 4px;
        background: transparent;
    }
    .budget-input:focus {
        outline: none;
        border-bottom: 2px solid #003087;
        background-color: #f8f9fa;
    }
    .section-header {
        background-color: #e9ecef !important;
        font-weight: 600;
    }
    .amount-cell {
        text-align: right;
        font-weight: 500;
    }
    .total-row {
        background-color: #d4edda !important;
        font-weight: 700;
    }
    .grand-total-row {
        background-color: #c3e6cb !important;
        font-weight: 800;
        font-size: 1.1rem;
    }
    .add-row-btn {
        font-size: 0.8rem;
        padding: 2px 8px;
    }
    .remove-btn {
        color: #dc3545;
        background: none;
        border: none;
        padding: 0 4px;
        cursor: pointer;
    }
    #amount-in-words {
        font-style: italic;
        color: #495057;
        border-top: 2px solid #003087;
        padding-top: 10px;
        margin-top: 15px;
    }
    .format-number {
        text-align: right;
        font-family: 'Courier New', monospace;
    }
    .budget-info {
        background-color: #f8f9fa;
        padding: 15px;
        border-radius: 5px;
        margin-bottom: 20px;
        border-left: 4px solid #003087;
    }
    .budget-header {
        background-color: #e9ecef;
        padding: 10px 15px;
        border-radius: 5px;
        margin-bottom: 20px;
        font-weight: 600;
    }
</style>
{% endblock %}

{% block content %}
<div class="container-fluid">
    <div class="card mb-4">
        <div class="card-header bg-primary text-white">
            <div class="d-flex justify-content-between align-items-center">
                <h5 class="mb-0"><i class="bi bi-calculator me-2"></i>{{ page_title }}</h5>
            </div>
        </div>
        <div class="card-body">
            <!-- Budget Metadata Form -->
            <div class="row mb-4">
                <div class="col-md-6">
                    {{ form.budget_head|as_crispy_field }}
                    <small class="text-muted">Main budget head/category name</small>
                </div>
                <div class="col-md-6">
                    {{ form.department|as_crispy_field }}
                </div>
                <div class="col-md-4">
                    {{ form.year|as_crispy_field }}
                </div>
                <div class="col-md-4">
                    {{ form.budget_type|as_crispy_field }}
                </div>
            </div>
            
            <!-- Budget Items Table (Individual Budget Heads) -->
            <h6 class="mt-4 mb-3"><i class="bi bi-list-ul me-2"></i>Budget Items (Budget Heads)</h6>
            <p class="text-muted small mb-3">Add individual budget heads under this budget category</p>
            
            <div class="table-responsive">
                <table class="table table-bordered budget-table" id="budget-table">
                    <thead>
                        <tr>
                            <th width="8%">CTR</th>
                            <th width="32%">Budget Head (Expenditure Description)</th>
                            <th width="15%">Proposed Amount (₦)</th>
                            <th width="20%">Justification</th>
                            <th width="20%">Remarks</th>
                            <th width="5%">Action</th>
                        </tr>
                    </thead>
                    <tbody id="budget-items">
                        <!-- Items will be added here -->
                    </tbody>
                    <tfoot>
                        <tr class="grand-total-row">
                            <td colspan="2" class="text-end"><strong>GRAND TOTAL:</strong></td>
                            <td class="amount-cell"><span id="grand-total">₦0.00</span></td>
                            <td colspan="3"></td>
                        </tr>
                    </tfoot>
                </table>
            </div>
            
            <!-- Add Section Button -->
            <div class="mt-3">
                <button type="button" class="btn btn-sm btn-primary" id="add-section-btn">
                    <i class="bi bi-plus-circle me-1"></i>Add Section
                </button>
                <small class="text-muted ms-2">Sections help group related budget heads</small>
            </div>
            
            <!-- Amount in Words -->
            <div id="amount-in-words" class="mt-4"></div>
            
            <!-- Hidden form for submission -->
            <form method="post" id="budget-form">
                {% csrf_token %}
                <input type="hidden" name="items_data" id="items-data">
                
                <div class="mt-4">
                    <button type="submit" class="btn btn-npa">
                        <i class="bi bi-save me-2"></i>Save Budget
                    </button>
                    <a href="{% url 'budget_list' %}" class="btn btn-outline-secondary ms-2">
                        Cancel
                    </a>
                </div>
            </form>
        </div>
    </div>
</div>

<script>
    // Global variables
    let sectionCounter = 0;
    let initialItems = [];
    
    {% if initial_items %}
        try {
            initialItems = JSON.parse('{{ initial_items|escapejs }}');
            console.log('Initial items loaded:', initialItems.length);
        } catch(e) {
            console.error('Error parsing initial items:', e);
            initialItems = [];
        }
    {% endif %}
    
    // Format number with commas
    function formatNumber(amount) {
        if (isNaN(amount) || amount === null) return '0.00';
        return parseFloat(amount).toLocaleString('en-NG', {
            minimumFractionDigits: 2,
            maximumFractionDigits: 2
        });
    }
    
    // Format currency
    function formatCurrency(amount) {
        return '₦' + formatNumber(amount);
    }
    
    // Parse formatted number back to float
    function parseNumber(formatted) {
        if (!formatted) return 0;
        return parseFloat(formatted.toString().replace(/[₦,]/g, '')) || 0;
    }
    
    // Number to words function
    function numberToWords(num) {
        if (num === 0) return 'Zero Naira Only';
        
        const ones = ['', 'One', 'Two', 'Three', 'Four', 'Five', 'Six', 'Seven', 'Eight', 'Nine',
                     'Ten', 'Eleven', 'Twelve', 'Thirteen', 'Fourteen', 'Fifteen', 'Sixteen', 
                     'Seventeen', 'Eighteen', 'Nineteen'];
        const tens = ['', '', 'Twenty', 'Thirty', 'Forty', 'Fifty', 'Sixty', 'Seventy', 'Eighty', 'Ninety'];
        
        function convertLessThanThousand(n) {
            if (n === 0) return '';
            if (n < 20) return ones[n];
            if (n < 100) return tens[Math.floor(n / 10)] + (n % 10 !== 0 ? ' ' + ones[n % 10] : '');
            return ones[Math.floor(n / 100)] + ' Hundred' + (n % 100 !== 0 ? ' ' + convertLessThanThousand(n % 100) : '');
        }
        
        let naira = Math.floor(num);
        let result = '';
        
        if (naira >= 1000000) {
            result += convertLessThanThousand(Math.floor(naira / 1000000)) + ' Million ';
            naira %= 1000000;
        }
        if (naira >= 1000) {
            result += convertLessThanThousand(Math.floor(naira / 1000)) + ' Thousand ';
            naira %= 1000;
        }
        if (naira > 0) {
            result += convertLessThanThousand(naira);
        }
        
        return result.trim() + ' Naira Only';
    }
    
    // Add new section
    function addSection(sectionName = 'Main Budget') {
        const sectionId = 'section_' + Date.now() + '_' + Math.random().toString(36).substr(2, 9);
        sectionCounter++;
        
        const tbody = document.getElementById('budget-items');
        if (!tbody) return;
        
        const sectionRow = document.createElement('tr');
        sectionRow.className = 'section-header';
        sectionRow.dataset.sectionId = sectionId;
        sectionRow.innerHTML = `
            <td colspan="6">
                <div class="d-flex justify-content-between align-items-center">
                    <input type="text" class="form-control form-control-sm" 
                        value="${sectionName}" placeholder="Section Title (e.g., Civil Works, Electrical, etc.)"
                        style="width: 400px;" onchange="updateSectionName(this, '${sectionId}')">
                    <div>
                        <button type="button" class="btn btn-sm btn-success add-row-btn me-2" 
                                onclick="addItem('${sectionId}')">
                            <i class="bi bi-plus"></i> Add Budget Head
                        </button>
                        <button type="button" class="btn btn-sm btn-danger add-row-btn" 
                                onclick="removeSection('${sectionId}')">
                            <i class="bi bi-trash"></i> Remove Section
                        </button>
                    </div>
                </div>
            </td>
        `;
        
        tbody.appendChild(sectionRow);
        updateGrandTotal();
    }
    
    // Add item (budget head) to section
    function addItem(sectionId) {
        const itemId = 'item_' + Date.now() + '_' + Math.random().toString(36).substr(2, 9);
        const sectionRow = document.querySelector(`tr[data-section-id="${sectionId}"]`);
        if (!sectionRow) return;
        
        const tbody = document.getElementById('budget-items');
        
        const itemRow = document.createElement('tr');
        itemRow.className = 'budget-item';
        itemRow.dataset.itemId = itemId;
        itemRow.dataset.sectionId = sectionId;
        itemRow.innerHTML = `
            <td>
                <input type="text" class="budget-input ctr-input" placeholder="e.g., CTR-001">
            </td>
            <td>
                <textarea class="budget-input description-input" rows="2" 
                          placeholder="Enter budget head description"></textarea>
            </td>
            <td>
                <input type="text" class="budget-input amount-input format-number" 
                       placeholder="0.00" oninput="formatAmountField(this)" 
                       onblur="updateItemAmount(this)">
            </td>
            <td>
                <textarea class="budget-input justification-input" rows="2" 
                          placeholder="Justification for this budget head"></textarea>
            </td>
            <td>
                <textarea class="budget-input remarks-input" rows="2" 
                          placeholder="Additional remarks"></textarea>
            </td>
            <td class="text-center">
                <button type="button" class="remove-btn" onclick="removeItem('${itemId}')">
                    <i class="bi bi-trash"></i>
                </button>
            </td>
        `;
        
        // Insert after section or after last item
        let insertAfter = sectionRow;
        let nextRow = sectionRow.nextElementSibling;
        
        while (nextRow && !nextRow.classList.contains('section-header')) {
            insertAfter = nextRow;
            nextRow = nextRow.nextElementSibling;
        }
        
        insertAfter.parentNode.insertBefore(itemRow, insertAfter.nextElementSibling);
        updateGrandTotal();
    }
    
    // Format amount field as user types
    function formatAmountField(input) {
        let value = input.value.replace(/[₦,]/g, '');
        if (value && !isNaN(value)) {
            let num = parseFloat(value);
            if (!isNaN(num)) {
                input.value = formatNumber(num);
            }
        }
    }
    
    // Update item amount and grand total
    function updateItemAmount(input) {
        let value = input.value.replace(/[₦,]/g, '');
        let num = parseFloat(value) || 0;
        input.value = formatNumber(num);
        updateGrandTotal();
    }
    
    // Update grand total
    function updateGrandTotal() {
        let total = 0;
        document.querySelectorAll('.amount-input').forEach(input => {
            let value = input.value.replace(/[₦,]/g, '');
            total += parseFloat(value) || 0;
        });
        
        document.getElementById('grand-total').textContent = formatCurrency(total);
        document.getElementById('amount-in-words').innerHTML = 
            `<strong>Amount in Words:</strong> ${numberToWords(total)}`;
        
        storeBudgetData();
    }
    
    // Store budget data
    function storeBudgetData() {
        const budgetData = [];
        const sections = document.querySelectorAll('.section-header');
        
        sections.forEach(section => {
            const sectionNameInput = section.querySelector('input');
            const sectionName = sectionNameInput ? sectionNameInput.value : 'Unnamed Section';
            
            let nextRow = section.nextElementSibling;
            while (nextRow && !nextRow.classList.contains('section-header')) {
                if (nextRow.classList.contains('budget-item')) {
                    const ctrInput = nextRow.querySelector('.ctr-input');
                    const descInput = nextRow.querySelector('.description-input');
                    const amountInput = nextRow.querySelector('.amount-input');
                    const justInput = nextRow.querySelector('.justification-input');
                    const remarksInput = nextRow.querySelector('.remarks-input');
                    
                    budgetData.push({
                        section: sectionName,
                        ctr: ctrInput ? ctrInput.value : '',
                        description: descInput ? descInput.value : '',
                        amount: amountInput ? amountInput.value.replace(/[₦,]/g, '') : '0',
                        justification: justInput ? justInput.value : '',
                        remarks: remarksInput ? remarksInput.value : ''
                    });
                }
                nextRow = nextRow.nextElementSibling;
            }
        });
        
        const itemsDataField = document.getElementById('items-data');
        if (itemsDataField) {
            itemsDataField.value = JSON.stringify(budgetData);
        }
    }
    
    // Remove section
    function removeSection(sectionId) {
        if (confirm('Remove this section and all its budget heads?')) {
            const sectionRow = document.querySelector(`tr[data-section-id="${sectionId}"]`);
            if (sectionRow) {
                let nextRow = sectionRow.nextElementSibling;
                while (nextRow && !nextRow.classList.contains('section-header')) {
                    const toRemove = nextRow;
                    nextRow = nextRow.nextElementSibling;
                    toRemove.remove();
                }
                sectionRow.remove();
                updateGrandTotal();
            }
        }
    }
    
    // Remove item (budget head)
    function removeItem(itemId) {
        if (confirm('Remove this budget head?')) {
            const itemRow = document.querySelector(`tr[data-item-id="${itemId}"]`);
            if (itemRow) {
                itemRow.remove();
                updateGrandTotal();
            }
        }
    }
    
    // Update section name
    function updateSectionName(input, sectionId) {
        storeBudgetData();
    }
    
    // Load existing items
    function loadExistingItems() {
        const tbody = document.getElementById('budget-items');
        if (!tbody) return;
        
        // Clear any existing rows
        tbody.innerHTML = '';
        
        if (!initialItems || initialItems.length === 0) {
            addSection('Main Budget');
            return;
        }
        
        // Group by section
        const sections = {};
        initialItems.forEach(item => {
            const sectionName = item.section || 'Main Budget';
            if (!sections[sectionName]) {
                sections[sectionName] = [];
            }
            sections[sectionName].push(item);
        });
        
        // Create sections and add items
        Object.keys(sections).forEach(sectionName => {
            addSection(sectionName);
            
            const sectionRows = document.querySelectorAll('.section-header');
            const sectionRow = sectionRows[sectionRows.length - 1];
            const sectionId = sectionRow.dataset.sectionId;
            
            sections[sectionName].forEach(item => {
                addItem(sectionId);
                
                const itemRows = document.querySelectorAll('.budget-item');
                const newRow = itemRows[itemRows.length - 1];
                
                if (item.ctr) newRow.querySelector('.ctr-input').value = item.ctr;
                if (item.description) newRow.querySelector('.description-input').value = item.description;
                if (item.amount) {
                    let num = parseFloat(item.amount) || 0;
                    newRow.querySelector('.amount-input').value = formatNumber(num);
                }
                if (item.justification) newRow.querySelector('.justification-input').value = item.justification;
                if (item.remarks) newRow.querySelector('.remarks-input').value = item.remarks;
            });
        });
        
        updateGrandTotal();
    }
    
    // Initialize page
    document.addEventListener('DOMContentLoaded', function() {
        console.log('DOM loaded, initializing budget page');
        loadExistingItems();
        
        // Add section button
        const addSectionBtn = document.getElementById('add-section-btn');
        if (addSectionBtn) {
            addSectionBtn.addEventListener('click', function() {
                const sectionName = prompt('Enter section name:', 'New Section');
                if (sectionName && sectionName.trim()) {
                    addSection(sectionName.trim());
                }
            });
        }
        
        // Form submission
        const budgetForm = document.getElementById('budget-form');
        if (budgetForm) {
            budgetForm.addEventListener('submit', function(e) {
                console.log('Form submitting, storing data...');
                storeBudgetData();
                
                // Validate at least one item
                const itemsData = document.getElementById('items-data').value;
                const items = JSON.parse(itemsData || '[]');
                if (items.length === 0) {
                    e.preventDefault();
                    alert('Please add at least one budget head before saving.');
                }
            });
        }
    });
</script>
{% endblock %}